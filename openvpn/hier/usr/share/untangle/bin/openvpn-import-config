#!/bin/bash

#
# This script imports a config file containing the necessary configuration to connect to a remote server.
# It stores the files in settings; OpenVpnManager will later copy them into place.
#

set -euo pipefail

filename="${1:-}"
TMPDIR=""

cleanup() {
    if [[ -n "${TMPDIR}" && -d "${TMPDIR}" ]]; then
        rm -rf "${TMPDIR}"
    fi
    exit 1
}

if [[ -z "${filename}" || ! -f "${filename}" ]]; then
    echo "Unable to find the file: ${filename}"
    exit 1
fi

ext="${filename##*.}"

case "$ext" in
    zip)
        TMPDIR=$(mktemp -d) || exit 3

        if ! unzip -q "${filename}" -d "${TMPDIR}"; then
            cleanup
        fi

        CONF_FILE_PATH=$(find "${TMPDIR}/untangle-vpn" -name "*.conf" | head -n 1)

        if [[ -z "${CONF_FILE_PATH}" || ! -f "${CONF_FILE_PATH}" ]]; then
            echo "Missing conf file"
            cleanup
        fi

        SITENAME=$(basename "${CONF_FILE_PATH}" .conf)

        # Output site name (required by Java code)
        echo "SiteName: ${SITENAME}"

        if [[ -z "${SITENAME}" ]]; then
            echo "Missing site name"
            cleanup
        fi

        CONF_DIR="@PREFIX@/usr/share/untangle/settings/openvpn/remote-servers"
        KEYS_DIR="${CONF_DIR}/keys"
        CONF_FILE="${CONF_DIR}/${SITENAME}.conf"

        mkdir -p "${CONF_DIR}" "${KEYS_DIR}"

        if ! cp "${CONF_FILE_PATH}" "${CONF_FILE}"; then
            echo "Copy failed"
            cleanup
        fi

        if [[ -d "${TMPDIR}/untangle-vpn/keys" ]]; then
            if ! cp -r "${TMPDIR}/untangle-vpn/keys/"* "${KEYS_DIR}/"; then
                echo "Key Copy failed"
                echo "${TMPDIR}"
                cleanup
            fi
        fi

        rm -rf "${TMPDIR}"

        echo "New configuration imported: ${CONF_FILE}"
        ;;

    ovpn)
        SITENAME=$(basename "${filename}" .ovpn | sed -E 's/[ ()]//g; s/-[0-9]+$//')

        # Output site name (required by Java code)
        echo "SiteName: ${SITENAME}"

        if [[ -z "${SITENAME}" ]]; then
            echo "Missing site name"
            exit 1
        fi

        CONF_DIR="@PREFIX@/usr/share/untangle/settings/openvpn/remote-servers"
        CONF_FILE="${CONF_DIR}/${SITENAME}.conf"

        mkdir -p "${CONF_DIR}"

        if ! cp "${filename}" "${CONF_FILE}"; then
            echo "Failed to copy .ovpn file"
            exit 1
        fi

        echo "Inline .ovpn configuration imported: ${CONF_FILE}"
        ;;

    *)
        echo "Unsupported file format: .${ext}"
        exit 2
        ;;
esac
