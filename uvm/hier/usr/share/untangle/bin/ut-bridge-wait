#! /bin/bash

exec 2>&1 | logger -t uvmiptables

MAX_DELAY=$1
## Default amount of time, in seconds to wait for the bridge to come up
DEFAULT_DELAY=20

## State of the bridge interface once it is ready to transmit
FORWARD_STATE=3
DISABLED_STATE=0

if [ -z "${MAX_DELAY}" ]; then
    MAX_DELAY=${DEFAULT_DELAY}
fi

## Prints a string if the bridge is ready.
function isBridgeReady()
{
    ## This is a test to determine if there are any interfaces that are in the forwarding state
    ## Search for any bridge ports that are not in the forward state
    local t_status=`find /sys/class/net -path '/sys/class/net/eth*/brport/state' | xargs grep -v '\(0\|3\)'`

    if [ -z "${t_status}" ]; then
        echo "true"
    fi
}

for (( count = 0 ; count < ${MAX_DELAY} ; count++ )); do
    if [ -n "`isBridgeReady`" ]; then
        break
    fi
    sleep 1
done

echo "[DEBUG:`date`] Waited ${count} seconds for the bridge."

exit 0