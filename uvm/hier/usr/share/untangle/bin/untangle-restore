#! /bin/bash

INST_OPTS=" -o DPkg::Options::=--force-confnew --yes --force-yes --fix-broken "
UPGD_OPTS=" -o DPkg::Options::=--force-confnew --yes --force-yes --fix-broken "

restore_db()
{
    infile=$1

    dropdb -U postgres uvm >/dev/null 2>&1
    createuser -U postgres -d -A untangle 2>/dev/null
    createdb -O postgres -U postgres uvm >/dev/null 2>&1

#    if confirm "Restore settings?"; then
        zcat $infile | psql -X -U postgres uvm >/dev/null 2>&1

        ## Set the unconfigured flag, so the box will reconfigure the network configuration a restart
        echo "update u_network_settings set setup_state=67 where setup_state=3" \
            | psql -X -U postgres uvm >/dev/null 2>&1
        echo "update u_network_settings set setup_state=68 where setup_state=4" \
            | psql -X -U postgres uvm >/dev/null 2>&1
#    fi
}

clean_dirs()
{
    rm -rf /usr/share/untangle/conf/openvpn
    rm -rf /etc/openvpn
    rm -f  /usr/share/untangle/conf/dirbackup.ldif
}

restore_packages()
{
    instfile=$1

    apt-get update >> /var/log/uvm/apt.log 2>&1
    apt-get dist-upgrade $UPGD_OPTS >> /var/log/uvm/apt.log 2>&1
    /etc/init.d/untangle-vm stop
    cat $instfile | cut -d' ' -f1 | grep -- '-storeitem$' \
        | xargs apt-get install $INST_OPTS >> /var/log/uvm/apt.log 2>&1
}


if [ $# -lt 3 ] ; then
    echo "Usage: $0 dumpfile tarfile instfile"
fi

dumpfile=$1
tarfile=$2
instfile=$3

# stop the UVM, depending on circumstances may already be stopped
/etc/init.d/untangle-vm stop

# restore the database
restore_db $dumpfile

# clean out stuff that restore would otherwise append to
clean_dirs

# restore the files, both system and the /usr/share/untangle important stuf
tar zxf $tarfile -C /

# restore the LDAP configuration
if [ -x /usr/sbin/slapadd -a -f /usr/share/untangle/conf/dirbackup.ldif ]; then
    /etc/init.d/slapd stop
    rm -rf /var/lib/ldap
    mkdir /var/lib/ldap
    cp /usr/share/untangle/conf/ldap.DB_CONFIG /var/lib/ldap/DB_CONFIG
    /usr/sbin/slapadd -l /usr/share/untangle/conf/dirbackup.ldif
    /usr/sbin/slapindex
    /etc/init.d/slapd start
fi

# try to download needed files, this may fail because the network settings may not be correct
restore_packages $instfile

# restart the networking with new settings
/etc/init.d/networking restart

# try again just in case these network settings are "better" than the previous
restore_packages $instfile

# start the UVM, depending on circumstances (menu driven restore) may need to be restopped
/etc/init.d/untangle-vm start > /dev/null 2>&1

