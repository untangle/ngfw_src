#!/bin/dash

exec 2> /dev/null

update_pppoe()
{
    local t_sub
    local t_pid
    local t_intf_name
    local t_connection_file
    local t_temp

    t_sub=""
    for t_pid in /var/run/ppp*.pid ; do
        [ -f "${t_pid}" ] || continue

        t_intf_name=`echo ${t_pid} | sed -e 's|/var/run/\([^\.]\+\)\.pid|\1|'`
        [ "${t_intf_name}" = "${t_pid}" ] && continue
        
        t_pid=`cat ${t_pid}`
        
        [  -f /proc/${t_pid}/cmdline ]  || continue
        t_connection_file=`cat "/proc/${t_pid}/cmdline" | tr '\000' '\001' | awk -v RS='\001' '/^connection./ { print ; exit }'`
        t_connection_file="/etc/ppp/peers/${t_connection_file}"
        [ -f "${t_connection_file}" ] || continue
        
        if [ "`basename ${t_connection_file}`" = "connection0" ]; then
            t_index=1
        else
            t_index=`awk '/# *PPPOE_UPLINK_INDEX=/ { sub( "# *PPPOE_UPLINK_INDEX=", "" ); print ; exit }' \
                "${t_connection_file}"`
        fi

        [ -z "${t_index}" ] && continue
        
        t_sub="sub( \":[^:]*:${t_index},\", \":${t_intf_name}:\" ${t_index} \",\" ) ; ${t_sub}"
    done
    
    [ -z "${t_sub}" ] && return 
    [ -f "${INTERFACE_PROPERTIES}" ] || return
    
    t_temp=`mktemp`

    [ -f ${t_temp} ] || return

    awk "/^com.untangle.interface-order=/ { ${t_sub} print ; next } ; { print }" \
        "${INTERFACE_PROPERTIES}" > ${t_temp}

    diff -q ${t_temp} "${INTERFACE_PROPERTIES}" >&2 || {
        echo "[DEBUG:`date`] Updating interface properties for PPPoE" >&2
        mv ${t_temp} "${INTERFACE_PROPERTIES}"
        chmod 0644  "${INTERFACE_PROPERTIES}"
    }

    rm -f ${t_temp}
}

## Start of script
INTERFACE_PROPERTIES=/etc/untangle-net-alpaca/interface.properties

update_pppoe

[ -f "${INTERFACE_PROPERTIES}" ] && {
    cat "${INTERFACE_PROPERTIES}"
}

true

