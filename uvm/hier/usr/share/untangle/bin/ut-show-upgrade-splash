#! /bin/sh

BASENAME="uvm-upgrade"

SHARE="@PREFIX@/usr/share/untangle/web/upgrade"

APACHE_HTML_PAGE="${SHARE}/${BASENAME}.html"
APACHE_JS_PAGE="${SHARE}/${BASENAME}.js"
APACHE_UPGRADE_HTML_DIR="/var/www"
APACHE_UPGRADE_HTML_PAGE="${APACHE_UPGRADE_HTML_DIR}/${BASENAME}.html"
APACHE_UPGRADE_JS_PAGE="${APACHE_UPGRADE_HTML_DIR}/${BASENAME}.js"
APACHE_UPGRADE_CONFIG_FILE="/etc/apache2/conf.d/${BASENAME}"

APACHE_UPGRADE_CONFIG="RedirectMatch 302 ^/(webui|auth|login|index).* /uvm-upgrade.html\nRedirectMatch 302 ^/$ /uvm-upgrade.html"
APACHE_UPGRADEDONE_CONFIG="RedirectMatch 302 ^/$(basename $APACHE_HTML_PAGE).* /webui"
#RewriteEngine does not handle HTTPS port correctly
#APACHE_UPGRADE_CONFIG="RewriteEngine On\nRewriteRule ^/(webui|auth|login|index).* /uvm-upgrade.html [R=302]\nRewriteRule ^/$ /uvm-upgrade.html [R=302]\n"
#APACHE_UPGRADEDONE_CONFIG="RewriteEngine On\nRewriteRule ^/$(basename $APACHE_HTML_PAGE).* /webui [R=302]\n"

CONSOLIDATED_UPGRADE_LOG="/var/www/${BASENAME}.log"
UPGRADE_LOGS=$(ls @PREFIX@/var/log/uvm/{wrapper,uvm,console,apt}.log)

# The PID file stores the pid of the tail process dumping to the log
# It is also the indicator the untangle-vm checks to see if the upgrade screen is being displayed
PIDFILE=/var/run/${BASENAME}.pid

# during the preinst of the 1st untangle-vm package containing the
# show-upgrade mechanism, the necessary files are not there yet, so do
# not proceed
[ -d "$SHARE" ] || exit 0

case "$1" in
  start)
    # setup upgrade page
    cp -f $APACHE_HTML_PAGE $APACHE_UPGRADE_HTML_PAGE
    cp -f $APACHE_JS_PAGE $APACHE_UPGRADE_JS_PAGE
    echo -e $APACHE_UPGRADE_CONFIG >| $APACHE_UPGRADE_CONFIG_FILE
    a2ensite default

    # setup consolidated upgrade log
    rm -f $CONSOLIDATED_UPGRADE_LOG
    touch $CONSOLIDATED_UPGRADE_LOG
    nohup tail -f $UPGRADE_LOGS >> $CONSOLIDATED_UPGRADE_LOG 2>&1 &
    echo $! >| $PIDFILE

    /etc/init.d/apache2 restart ;;

  stop)
    a2dissite default
    echo -e $APACHE_UPGRADEDONE_CONFIG >| $APACHE_UPGRADE_CONFIG_FILE
    /etc/init.d/apache2 restart
    if [ -f $PIDFILE ] ; then
        kill $(cat $PIDFILE)
        rm -f $PIDFILE
    fi
    rm -f $CONSOLIDATED_UPGRADE_LOG $APACHE_UPGRADE_HTML_PAGE $APACHE_UPGRADE_JS_PAGE ;;
esac

exit 0
