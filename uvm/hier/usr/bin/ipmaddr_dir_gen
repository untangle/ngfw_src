#!/bin/sh

set -e

make_dir()
{
    psql -X -U postgres uvm >/dev/null <<EOF
DELETE FROM ipmaddr_dir;
INSERT INTO ipmaddr_dir (id, notes) VALUES (nextval('hibernate_sequence'), 'foo');
EOF

    echo "SELECT id FROM ipmaddr_dir;" | psql -X -U postgres uvm | egrep '^ [0-9]+' \
        | sed -e 's/^ \([0-9]*\)/\1/'
}

gen_dml ()
{
    ip=$(host $1 | cut -f3)

    name=$2

    let 'idx = idx + 1'
    echo "index: $idx"

    psql -X -a -U postgres uvm <<EOF
INSERT INTO ipmaddr_rule (rule_id, ipmaddr, name, description, live, alert, log)
       VALUES (nextval('hibernate_sequence'), '$ip', '$name', '$name', true, true, true);

INSERT INTO ipmaddr_dir_entries (ipmaddr_dir_id, rule_id, pos_idx)
       VALUES ($dir_id, currval('hibernate_sequence'), $idx);
EOF
}

dir_id=$(make_dir)

idx=0

gen_dml butters "Executive Suite"
gen_dml jlo "Engineering"
gen_dml marklar "QA"
gen_dml tweek "Skunkworks"
gen_dml parishilton "Marketing"
gen_dml slab "Engineering"
