#! /bin/bash

. @PREFIX@/etc/default/untangle-vm

NAME="$0"
REG_KEY="$1"

if [ -n "$REG_KEY" ] ; then # boxes with physical activation keys
  echo $REG_KEY > $ACTIVATION_KEY_FILE

  if [[ $REG_KEY != $FAKE_KEY ]] ; then
    $KEY_VERIFICATION $REG_KEY 2> /dev/null
    VERIFY_RES="$?"
    if [ "$VERIFY_RES" -eq 1 ]; then
      echo "Key is invalid: $REG_KEY"
      rm -f $ACTIVATION_KEY_FILE
      exit 1
    elif [ "$VERIFY_RES" -ne 0 ]; then
      echo "Error validating registration.  Unable to continue."
      rm -f $ACTIVATION_KEY_FILE
      exit 2
    fi
  fi

  # If we get here, the key is good.
  echo "Key is valid"
fi

if [ ! -f $ACTIVATION_KEY_FILE -o ! -f $POPID_FILE ]; then
    # we need a popid
    echo "`date` $NAME: about to create pop id" >> $UVM_WRAPPER_LOG
    output=`ruby @UVM_HOME@/bin/createpopid.rb 2>&1`
    if [ $? = 0 ] ; then
	echo "`date` $NAME: created pop id" >> $UVM_WRAPPER_LOG
    else
	echo "`date` $NAME: failed to create pop id; output was: '$output'"
	exit 1
    fi
fi

POPID=`cat $POPID_FILE`

# add untangle sources to sources.list; remove the old ones
echo "Installing sources list"
touch $SOURCES_LIST
perl -i -pe 's/.*untangle\.com.*//' $SOURCES_LIST
echo -e $DEFAULT_UNTANGLE_SOURCE | sed "s/$KEY_TEMPLATE/$POPID/" >> $SOURCES_LIST
nohup apt-get update >& /dev/null &

@UVM_HOME@/bin/utregister

exit 0
