#! /bin/bash

set -e

. @PREFIX@/etc/default/untangle-vm

REGISTRATION_DONE_FILE=${REGISTRATION_DONE_FILE:-@UVM_HOME@/.regdone}
REGISTRATION_INFO_FILE=${REGISTRATION_INFO_FILE:-@UVM_HOME@/registration.info}

if [ -f "$REGISTRATION_INFO_FILE" ]; then
    if [ ! -f "$REGISTRATION_DONE_FILE" -o "$REGISTRATION_DONE_FILE" -ot "$REGISTRATION_INFO_FILE" ]; then
	/bin/rm -f "$REGISTRATION_DONE_FILE"

	/usr/bin/curl --max-time 20 -o /dev/null -d "`cat $REGISTRATION_INFO_FILE`" "https://poptrack.untangle.com/register/custreg.php"
	if [ "$?" -eq "0" ]; then
	    /bin/touch "$REGISTRATION_DONE_FILE"
	fi
    fi
fi

