# -*-ruby-*-

$DevelBuild = true
ARGV.each do |arg|
  if "pkgs" == arg then
    $DevelBuild = false
  elsif arg =~ /release_?(.+)?/
    # XXX release the hoonds!
    releaseName = $1 || ENV["USER"]
    $DevelBuild = false

    task arg.to_sym => :pkgs do
      Kernel.system('./buildtools/release.sh', 'all', releaseName)
    end
  end
end

## Building downloads
Kernel.system( "make -C ../downloads" )

## This is how you define where the stamp file will go
module Rake
  StampFile = 'taskstamps.txt'
end

require 'buildtools/stamp-task.rb'

require 'buildtools/rake-util.rb'
require 'buildtools/c-compiler.rb'
require 'buildtools/jars.rb'
require 'buildtools/jasper.rb'
require 'buildtools/transform.rb'

task :default => :devel
task :all => :devel

task :clean do
  FileUtils.rm_rf($BuildEnv.devel) if File.exist?($BuildEnv.devel)
  FileUtils.rm_rf($BuildEnv.staging) if File.exist?($BuildEnv.staging)
  FileUtils.rm_rf(FileList['debian/*.version'].map { |f| f =~ /(.*)\.version$/; $1 })
  ## Clear the stamp hashes
  Rake::StampHash.instance.clear
end

task :devel => [Package['install']]
$InstallTarget = InstallTarget.new(Package['install'], [Package['mvvm'], Package['untangle-client'], Package['tran']], 'install')

task :devel => $InstallTarget

# See rake-util.rb, we check the arguments for "pkgs"
task :pkgs => Package['install'] do
  FileList['./debian/**/etc/init.d/*'].each do |f|
    FileUtils.cp(f, "./debian/#{File.basename(f)}.init")
  end

  Kernel.system('./buildtools/incVersion.sh', 'all')
  Kernel.system(*%w(fakeroot ./debian/rules binary))
  Kernel.system(*%w(sudo ./buildtools/rebuildmvvm.sh))
end

task :pkgs => $InstallTarget

task Package['mvvm'] => [:structure]

task :structure do
  [$BuildEnv.devel, $BuildEnv.devel, $BuildEnv.grabbag].each do |t|
    ensureDirectory(t)
  end
end

## Require all of the sub packages.
## Done manually because order matters.
## XXX Could create a new helper method that sets a prefix directory before
## calling require and then unsets it afterwards.
require 'util/package.rb'
require 'libmvutil/package.rb'
require 'libnetcap/package.rb'
require 'libvector/package.rb'
require 'jmvutil/package.rb'
require 'jnetcap/package.rb'
require 'jvector/package.rb'
require 'nfutil/package.rb'
require 'mvvm/package.rb'
require 'gui/package.rb'
require 'tran/package.rb'

libalpine_so = "#{$BuildEnv.staging}/libalpine.so"

archives = ['libmvutil', 'libnetcap', 'libvector', 'jmvutil', 'jnetcap', 'jvector']

## Make the so dependent on each archive
archives.each do |n|
  file libalpine_so => Package[n]['archive']
end

file libalpine_so do
  compilerEnv = CCompilerEnv.new( { "flags" => "-pthread #{CCompilerEnv.defaultDebugFlags}" } )
  archivesFiles = archives.map { |n| Package[n]['archive'].filename }

  CBuilder.new(compilerEnv).makeSharedLibrary(archivesFiles, libalpine_so, [],
                                              ['xml2', 'sysfs', 'netfilter_queue'], ['ipq'])
end



$InstallTarget.registerDependency(libalpine_so)

$InstallTarget.installFiles(libalpine_so, "#{Package['mvvm'].distDirectory}/usr/lib/mvvm")

# DO IT!
#graphViz('foo.dot')
